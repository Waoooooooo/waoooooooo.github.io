<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>正则</title>
  <style>
    b {
      font-weight: normal;
      color: black;

      &:nth-child(odd) {
        background-color: rgb(99, 177, 249);
      }

      &:nth-child(even) {
        background-color: rgb(188, 219, 247);
      }
    }

    i[dataId] {
      font-weight: normal;
      font-style: normal;
      position: relative;
      z-index: 1;
      background-color: #db2727;
    }

    div {
      position: relative;

      >* {
        border: 2px solid #9fcfff;
        padding: 0;
        margin: 0px;
        position: absolute;
        width: 300px;
        height: 300px;
        background-color: transparent;
        font-size: large;

        text-wrap: wrap;
        overflow-wrap: break-word;
      }

      >pre {
        z-index: -1;


      }
    }
  </style>
</head>

<body>
  正则: <br>
  <input type="text" id="regString" value="ab(c)"> <button onclick="run()">run</button><br>
  <label>I <input type="checkbox" oninput="run()" id="checkI"></label>
  <label>S <input type="checkbox" oninput="run()" id="checkS"></label>
  <label>G <input type="checkbox" oninput="run()" checked id="checkG"></label>
  <label>M <input type="checkbox" oninput="run()" id="checkM"></label>
  <label>Y <input type="checkbox" oninput="run()" id="checkY"></label>
  <br>
  匹配字符串:
  <div>
    <textarea name="" id="inputString" cols="30" rows="10" oninput="run()">Tomsay:'abc'abc'asdasd.'asdas:'i'm strong.'Lucy:'can can  need?' Tom say:'How  are you?''
    </textarea>
    <pre id="pre"></pre>
  </div>
</body>
<script>
  run()
  function run() {
    var flag = ""
    if (checkI.checked) {
      flag += "i"
    }
    if (checkG.checked) {
      flag += "g"
    }
    if (checkM.checked) {
      flag += "m"
    }
    if (checkY.checked) {
      flag += "y"
    }
    if (checkS.checked) {
      flag += "s"
    }
    var string = inputString.value
    var re = new RegExp(regString.value, "d" + flag)
    var match
    var leftMap = {}
    var resultStr = ""
    var preIndex = 0
    while (match = re.exec(string)) {
      resultStr += string.slice(preIndex, match.index)
      preIndex = re.lastIndex
      var indices = match.indices
      //处理匹配到的字符串index - lastindex
      var matchStr = match[0]
      //如果存在分组,取出匹配到的分组,映射储存的是相对下标有几个tag
      if (indices.length > 1) {
        resultStr += "<b>"
        indices = indices.slice(1)
        var leftTagsMap = indices.reduce((map, e, i) => {
          var position = e[0] - match.index
          if (map[position]) {
            map[position]++
          } else {
            map[position] = 1
          }
          return map
        }, {})
        var rightTagsMap = indices.reduce((map, e, i) => {
          var position = e[1] - match.index
          if (map[position]) {
            map[position]++
          } else {
            map[position] = 1
          }
          return map
        }, {})
        //拼接匹配的字符串
        var i = 1 //i作为组号

        for (var index = 0; index < matchStr.length; index++) {
          var leftTag = ""
          var rightTag = ""
          while (leftTagsMap[index]) {
            leftTag += `<i dataId =${i}>`
            i++
            leftTagsMap[index]--
          }
          while (rightTagsMap[index]) {
            rightTag += `</i>`
            rightTagsMap[index]--
          }
          //如果左右标签同时存在 先拼右括号
          resultStr += leftTag + matchStr[index] + rightTag
        }
        rightTag = ""
        while (rightTagsMap[index]) {
          rightTag += `</i>`
          rightTagsMap[index]--
        }
        resultStr += rightTag
        resultStr += "</b>"
      } else {
        //没有分组
        //两边加上<b>
        resultStr += `<b>${matchStr}</b>`
      }
      if (match.global) {
        break
      }
    }
    //循环结束后将剩余部分拼接
    resultStr += string.slice(preIndex)
    //
    //
    // var resultStr=getStr(left,right,string)
    pre.innerHTML = resultStr
  }
  /* getStr 可以用map
   * @param {array} left 左边的标签位置
   * @param {array} right 右边的标签的位置
   * @param {string} string
   * @return {string}
  */
  function getStr(left, right, string) {
    var resultStr = ""
    //变成两行

    for (let index = 0; index < string.length; index++) {
      //获取左边标签
      var leftTag = left.reduce((str, e, i) => {
        if (index == e) {
          return str += `<i data=${i}>`
        }
        return str
      }, "")
      //获取右边标签
      var rightTag = right.reduce((str, e, i) => {
        if (index == e - 1) {
          return str += `</i>`
        }
        return str
      }, "")
      resultStr += leftTag + string[index] + rightTag
    }
    return resultStr
  }
</script>

</html>
