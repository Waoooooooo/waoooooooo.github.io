<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>花瓣网布局</title>

  <style>
    html,
    body {
      margin: 0;
      min-width: 550px;
    }

    * {
      background-color: #32323230
    }

    section {
      width: 80%;
      margin: auto;
      position: relative;
    }

    img {
      display: block;
      position: absolute;
      transition: 0.5s;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
</head>

<body>
  <section>
  </section>
  <script>
    var section = document.querySelector("section")
    var html = document.querySelector("html")
    var cats = [
      {
        "url": "photo-108273877.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-108273877.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "photo-115203323.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-115203323.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "photo-23583825.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/photo-23583825.jpg",
        "width": 2048,
        "height": 1536
      },
      {
        "url": "stock-photo-123942383.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-123942383.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-124559545.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-124559545.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-132046989.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132046989.jpg",
        "width": 1170,
        "height": 780
      },
      {
        "url": "stock-photo-132118343.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132118343.jpg",
        "width": 2000,
        "height": 1339
      },
      {
        "url": "stock-photo-132311221.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132311221.jpg",
        "width": 1920,
        "height": 1080
      },
      {
        "url": "stock-photo-132586903.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-132586903.jpg",
        "width": 2000,
        "height": 1334
      },
      {
        "url": "stock-photo-135203031.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-135203031.jpg",
        "width": 1000,
        "height": 668
      },
      {
        "url": "stock-photo-135626379.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-135626379.jpg",
        "width": 2000,
        "height": 1500
      },
      {
        "url": "stock-photo-136947953.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-136947953.jpg",
        "width": 2000,
        "height": 1348
      },
      {
        "url": "stock-photo-138378295.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-138378295.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-138436811.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-138436811.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-142950305.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-142950305.jpg",
        "width": 2000,
        "height": 1125
      },
      {
        "url": "stock-photo-143046061.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-143046061.jpg",
        "width": 843,
        "height": 1000
      },
      {
        "url": "stock-photo-143181649.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-143181649.jpg",
        "width": 2000,
        "height": 1298
      },
      {
        "url": "stock-photo-144530143.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-144530143.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-144730939.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-144730939.jpg",
        "width": 1000,
        "height": 1000
      },
      {
        "url": "stock-photo-146038669.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146038669.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-146231033.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146231033.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-146914861.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-146914861.jpg",
        "width": 843,
        "height": 1000
      },
      {
        "url": "stock-photo-147877407.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-147877407.jpg",
        "width": 2000,
        "height": 1334
      },
      {
        "url": "stock-photo-147969173.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-147969173.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-148015373.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148015373.jpg",
        "width": 1170,
        "height": 781
      },
      {
        "url": "stock-photo-148704233.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148704233.jpg",
        "width": 1170,
        "height": 884
      },
      {
        "url": "stock-photo-148928293.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148928293.jpg",
        "width": 1170,
        "height": 781
      },
      {
        "url": "stock-photo-148950715.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-148950715.jpg",
        "width": 1170,
        "height": 775
      },
      {
        "url": "stock-photo-21951271.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-21951271.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-21964829.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-21964829.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-22618399.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-22618399.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-31201539.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-31201539.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-34598868.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-34598868.jpg",
        "width": 542,
        "height": 768
      },
      {
        "url": "stock-photo-47252094.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-47252094.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-51980510.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-51980510.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-55601508.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-55601508.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-65681789.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-65681789.jpg",
        "width": 1840,
        "height": 1232
      },
      {
        "url": "stock-photo-70461471.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-70461471.jpg",
        "width": 1000,
        "height": 1000
      },
      {
        "url": "stock-photo-71801901.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-71801901.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-71913567.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-71913567.jpg",
        "width": 2000,
        "height": 1328
      },
      {
        "url": "stock-photo-72223295.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-72223295.jpg",
        "width": 2000,
        "height": 1335
      },
      {
        "url": "stock-photo-72620185.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-72620185.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-74402039.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-74402039.jpg",
        "width": 666,
        "height": 1000
      },
      {
        "url": "stock-photo-75097491.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-75097491.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-75186237.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-75186237.jpg",
        "width": 2000,
        "height": 1333
      },
      {
        "url": "stock-photo-79250373.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-79250373.jpg",
        "width": 2000,
        "height": 1325
      },
      {
        "url": "stock-photo-79692589.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-79692589.jpg",
        "width": 670,
        "height": 1000
      },
      {
        "url": "stock-photo-7979718.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-7979718.jpg",
        "width": 1024,
        "height": 680
      },
      {
        "url": "stock-photo-7980252.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-7980252.jpg",
        "width": 1024,
        "height": 680
      },
      {
        "url": "stock-photo-81390687.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-81390687.jpg",
        "width": 2000,
        "height": 1591
      },
      {
        "url": "stock-photo-81988949.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-81988949.jpg",
        "width": 667,
        "height": 1000
      },
      {
        "url": "stock-photo-83149705.jpg",
        "fullUrl": "https://xieranmaya.github.io/images/cats/stock-photo-83149705.jpg",
        "width": 775,
        "height": 1170
      }
    ];
    cats.push(..._.cloneDeep(cats))
    cats.push(..._.cloneDeep(cats))
    cats.push(..._.cloneDeep(cats))
    cats.push(..._.cloneDeep(cats))


    var clickCat = null

    //滚动条的10px
    run()
    var preIndexes
    html.addEventListener("click", function fun(event) {
      //如果存在被放大的猫 则使其在用户点击html时重置为初始位置初始大小 并结束函数
      if (clickCat) {
        clickCat.style.transform = ""
        clickCat.style.boxShadow = ""
        clickCat = null
        return
      }
      //如果触发事件的为img
      if (event.target.matches("img")) {
        var img = event.target
        //给全局变量clickcat赋值
        clickCat = img
        if (img.style.transform != "") {
          img.style.transform = ""
          img.style.boxShadow = ""
          return
        }
        //获取窗口的中点
        var windowHeight = window.innerHeight
        var windowWidth = window.innerWidth
        var imgPosition = img.getBoundingClientRect()
        //移动距离
        var x = windowWidth / 2 - imgPosition.x - imgPosition.width / 2
        var y = windowHeight / 2 - imgPosition.y - imgPosition.height / 2
        //放大系数 0.8倍的屏幕高度
        var coefficient = (windowHeight / imgPosition.height) * 0.8
        img.style.transform = `translate(${x}px, ${y}px) scale(${coefficient})`
        img.style.boxShadow = "0 0 0  9999px #000a"
        img.style.zIndex++
      }
    })



    //每当窗口宽高改变时
    window.onresize = run

    function run() {
      //1.获取section元素对象
      section.innerHTML = ""
      var sectionHeight = section.offsetHeight
      var sectionWidth = (window.innerWidth * 0.8) | 0
      section.style.width = sectionWidth + "px"

      var colWidth = 200
      //列的数量 = section 的宽度 / 200px 向下取整
      var colQuantity = (sectionWidth / colWidth) | 0
      //每列间隙 =   (section 的宽度  - colQuantity * 200 ) / colQuantity-1    取整
      var colGap = (sectionWidth - colQuantity * colWidth) / (colQuantity - 1) | 0
      //每列高
      var colHeights = Array(colQuantity).fill(0)
      //最矮列
      var minHeightCol = 0

      var imgs = []
      //2.计算所有猫猫的位置信息
      for (let index = 0; index < cats.length; index++) {
        const cat = cats[index];
        //2.1计算出猫猫图实际长度
        cat["realHeight"] = colWidth * cat.height / cat.width

        //2.2找出最矮的列的下标minHeightCol,并将高度累加到最矮列
        minHeightCol = colHeights.indexOf(Math.min(...colHeights))
        colHeights[minHeightCol] += cat["realHeight"] + colGap

        //2.3计算出每一张图片相对section的实际的位置  x =  列的序号 (从零开始)  *  gap +列宽 + 20%html
        cat["x"] = minHeightCol * (colGap + colWidth)
        cat["y"] = colHeights[minHeightCol] - cat["realHeight"]
        cat["id"] = index

        //2.4创建对象丢到图片数组里

        let img = document.createElement("img")
        img.src = cat.fullUrl
        img.id = `img${index}`
        img.style.width = colWidth + "px"
        img.style.height = cat["realHeight"] + "px"
        img.style.transform = `translate(${cat["x"]}px,${cat["y"]}px)`
        img.style.opacity = '0'
        img.onload = () => {
          //
          img.style.opacity = '1'
        }
        imgs.push(img)
      }
      //设定section的高度
      section.style.height = Math.max(...colHeights) + "px"
      //运行
      appendImg()
      //绑定函数
      window.onscroll = appendImg
      function appendImg() {
        //3  从imgs中筛选出需要显示的猫猫
        //3.1 屏幕最下方 =
        var html = document.querySelector("html")
        var 屏幕最下方 = html.scrollTop + window.innerHeight
        var 屏幕最上方 = html.scrollTop
        var 增量 = -50
        var showedCats = cats.filter(cat => cat.y < 屏幕最下方 + 增量 && cat.y > 屏幕最上方 - cat.realHeight - 增量)
        //3.2 找出符合条件的猫猫的img
        var indexes = showedCats.map(cat => cat.id)
        var indexesSet = new Set(indexes)
        //3.3 如果存在之前的猫猫图片数组
        if (preIndexes) {
          console.log(preIndexes)
          //存在的话
          var preIndexesSet = new Set(preIndexes)
          //1. preIndexes中不存在的 但 indexes 中存在 的是新增元素
          //indexes:当前次需要展示的图片对象的索引
          //preIndexes:上一次的图片对象的索引
          var 新增元素indexes = new Set(indexes.filter(i => !preIndexesSet.has(i)))
          var 新增元素s = imgs.filter((img, i) => 新增元素indexes.has(i))
          新增元素s.forEach((img) => {
            img.style.opacity = '0'
            setTimeout(() => {
              img.style.opacity = '1'
            },500);
          })
          section.append(...新增元素s)

          //2. preIndexes中存在的 indexes 中不存在的 是要删减的元素
          var 删减元素indexes = new Set(preIndexes.filter(i => !indexesSet.has(i)))
          var 删减元素s = imgs.filter((img, i) => 删减元素indexes.has(i))
          删减元素s.forEach(img => img.remove())

        } else {
          //不存在则直接加载全部
          var newImgs = imgs.filter((img, i) => indexesSet.has(i))
          section.append(...newImgs)
        }

        preIndexes = indexes
      }
    }
  </script>
</body>

</html>
